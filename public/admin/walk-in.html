<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Walk-in Order - BeanBox Café Admin</title>
  <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">☕</div>
        <h2>BeanBox Admin</h2>
        <p class="admin-email" id="adminEmail"></p>
      </div>
      
      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item">
          <span class="nav-icon">📊</span>
          <span class="nav-text">Dashboard</span>
        </a>
        <a href="analytics.html" class="nav-item">
          <span class="nav-icon">📈</span>
          <span class="nav-text">Analytics</span>
        </a>
        <a href="menu.html" class="nav-item">
          <span class="nav-icon">📋</span>
          <span class="nav-text">Menu</span>
        </a>
        <a href="live-orders.html" class="nav-item">
          <span class="nav-icon">🔔</span>
          <span class="nav-text">Live Orders</span>
        </a>
        <a href="completed.html" class="nav-item">
          <span class="nav-icon">✅</span>
          <span class="nav-text">Completed</span>
        </a>
        <a href="walk-in.html" class="nav-item active">
          <span class="nav-icon">🚶</span>
          <span class="nav-text">Walk-in Order</span>
        </a>
        <a href="#" class="nav-item nav-logout" onclick="handleLogout()">
          <span class="nav-icon">🚪</span>
          <span class="nav-text">Logout</span>
        </a>
      </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
      <header class="top-header">
        <button class="menu-toggle" id="menuToggle">☰</button>
        <h1>Walk-in Order</h1>
        <div class="header-actions">
          <span class="current-time" id="currentTime"></span>
        </div>
      </header>
      
      <div class="content-area">
        <div class="walkin-form">
          <h2 style="color: var(--primary); margin-bottom: 30px; font-weight: 800;">Create New Order</h2>
          
          <!-- Customer Info -->
          <div style="margin-bottom: 30px;">
            <h3 style="color: var(--primary); margin-bottom: 15px; font-weight: 700;">Customer Information</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
              <div class="form-group">
                <label>Customer Name *</label>
                <input type="text" id="customerName" class="form-input" placeholder="Enter name" required>
              </div>
              
              <div class="form-group">
                <label>Customer Email</label>
                <input type="email" id="customerEmail" class="form-input" placeholder="customer@example.com">
              </div>
              
              <div class="form-group">
                <label>Payment Type *</label>
                <select id="paymentType" class="form-select">
                  <option value="cash">Cash Payment</option>
                  <option value="online">Online Payment</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Search Menu -->
          <div style="margin-bottom: 30px;">
            <h3 style="color: var(--primary); margin-bottom: 15px; font-weight: 700;">Select Items</h3>
            <div class="search-bar">
              <input 
                type="text" 
                id="menuSearch" 
                class="search-input" 
                placeholder="🔍 Search menu items..."
                oninput="filterMenuItems()"
              >
            </div>
            
            <!-- Category Filter -->
            <div style="margin-bottom: 20px;">
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="filter-btn active" data-category="all" onclick="filterCategory('all')">All</button>
                <button class="filter-btn" data-category="Coffee" onclick="filterCategory('Coffee')">Coffee</button>
                <button class="filter-btn" data-category="Snacks" onclick="filterCategory('Snacks')">Snacks</button>
                <button class="filter-btn" data-category="Desserts" onclick="filterCategory('Desserts')">Desserts</button>
                <button class="filter-btn" data-category="Drinks" onclick="filterCategory('Drinks')">Drinks</button>
              </div>
            </div>
            
            <!-- Menu Items Grid -->
            <div id="menuGrid" class="walkin-menu">
              <div class="loading">Loading menu...</div>
            </div>
          </div>
          
          <!-- Cart -->
          <div class="walkin-cart" id="cartSection" style="display: none;">
            <h3>Order Summary</h3>
            <div class="walkin-cart-items" id="cartItems"></div>
            
            <div class="cart-total">
              <span>Total Amount:</span>
              <span>₹<span id="totalAmount">0</span></span>
            </div>
            
            <button class="btn btn-primary btn-block btn-large" onclick="placeOrder()">
              🛒 Place Order
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../js/utils.js"></script>
  <script src="../js/admin-common.js"></script>
  <script>
    let menuItems = [];
    let cart = {};
    let currentCategory = 'all';

    // Load menu
    async function loadMenu() {
      try {
        menuItems = await apiCall('/menu');
        displayMenu();
      } catch (error) {
        console.error('Error loading menu:', error);
        document.getElementById('menuGrid').innerHTML = 
          '<div class="empty-state">Failed to load menu</div>';
      }
    }

    // Display menu items
    function displayMenu() {
      const container = document.getElementById('menuGrid');
      const searchTerm = document.getElementById('menuSearch').value.toLowerCase();
      
      let filtered = menuItems.filter(item => item.inStock);
      
      // Filter by category
      if (currentCategory !== 'all') {
        filtered = filtered.filter(item => item.category === currentCategory);
      }
      
      // Filter by search
      if (searchTerm) {
        filtered = filtered.filter(item => 
          item.name.toLowerCase().includes(searchTerm) ||
          item.category.toLowerCase().includes(searchTerm)
        );
      }
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">No items found</div>';
        return;
      }
      
      container.innerHTML = filtered.map(item => `
        <div class="walkin-menu-item ${cart[item.id] ? 'selected' : ''}" onclick="toggleItem('${item.id}')">
          <div class="walkin-item-name">${item.name}</div>
          <div class="walkin-item-price">₹${item.price}</div>
          <div style="font-size: 12px; color: var(--text-light); margin-bottom: 10px;">${item.category}</div>
          ${cart[item.id] ? `
            <div class="quantity-control" style="justify-content: center;" onclick="event.stopPropagation()">
              <button class="btn-qty" onclick="updateQuantity('${item.id}', -1)">-</button>
              <span class="qty-display">${cart[item.id]}</span>
              <button class="btn-qty" onclick="updateQuantity('${item.id}', 1)">+</button>
            </div>
          ` : `
            <div style="text-align: center; color: var(--primary); font-weight: 600;">Click to Add</div>
          `}
        </div>
      `).join('');
    }

    // Toggle item in cart
    function toggleItem(itemId) {
      if (cart[itemId]) {
        delete cart[itemId];
      } else {
        cart[itemId] = 1;
      }
      displayMenu();
      updateCart();
    }

    // Update quantity
    function updateQuantity(itemId, change) {
      if (cart[itemId]) {
        cart[itemId] += change;
        
        if (cart[itemId] <= 0) {
          delete cart[itemId];
        }
      }
      
      displayMenu();
      updateCart();
    }

    // Update cart display
    function updateCart() {
      const cartSection = document.getElementById('cartSection');
      const cartItems = document.getElementById('cartItems');
      const totalAmount = document.getElementById('totalAmount');
      
      const cartKeys = Object.keys(cart);
      
      if (cartKeys.length === 0) {
        cartSection.style.display = 'none';
        return;
      }
      
      cartSection.style.display = 'block';
      
      let total = 0;
      const itemsHTML = cartKeys.map(itemId => {
        const item = menuItems.find(m => m.id === itemId);
        const itemTotal = item.price * cart[itemId];
        total += itemTotal;
        
        return `
          <div class="walkin-cart-item">
            <div>
              <div style="font-weight: 700; color: var(--primary);">${item.name}</div>
              <div style="font-size: 13px; color: var(--text-light);">₹${item.price} x ${cart[itemId]}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
              <span style="font-weight: 800; color: var(--primary);">₹${itemTotal}</span>
              <button class="btn-qty" onclick="updateQuantity('${itemId}', -1)" style="width: 30px; height: 30px;">-</button>
              <span style="font-weight: 700;">${cart[itemId]}</span>
              <button class="btn-qty" onclick="updateQuantity('${itemId}', 1)" style="width: 30px; height: 30px;">+</button>
              <button onclick="removeItem('${itemId}')" style="background: var(--danger); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;">×</button>
            </div>
          </div>
        `;
      }).join('');
      
      cartItems.innerHTML = itemsHTML;
      totalAmount.textContent = total;
    }

    // Remove item
    function removeItem(itemId) {
      delete cart[itemId];
      displayMenu();
      updateCart();
    }

    // Filter by category
    function filterCategory(category) {
      currentCategory = category;
      
      // Update active button
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.category === category) {
          btn.classList.add('active');
        }
      });
      
      displayMenu();
    }

    // Filter menu items by search
    function filterMenuItems() {
      displayMenu();
    }

    // Place order
    async function placeOrder() {
      const customerName = document.getElementById('customerName').value.trim();
      const customerEmail = document.getElementById('customerEmail').value.trim();
      const paymentType = document.getElementById('paymentType').value;
      
      if (!customerName) {
        showToast('Please enter customer name', 'error');
        return;
      }
      
      if (Object.keys(cart).length === 0) {
        showToast('Please add items to cart', 'error');
        return;
      }
      
      // Prepare order data
      const items = Object.keys(cart).map(itemId => {
        const item = menuItems.find(m => m.id === itemId);
        return {
          id: itemId,
          name: item.name,
          price: item.price,
          quantity: cart[itemId]
        };
      });
      
      const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      const orderData = {
        customerName,
        customerEmail: customerEmail || 'walkin@beanbox.com',
        items,
        total,
        paymentType,
        orderType: 'walk-in'
      };
      
      try {
        const order = await apiCall('/orders/walk-in', 'POST', orderData);
        
        showToast('Order placed successfully!', 'success');
        
        // Show order details
        alert(`Order Created Successfully!
        
Order ID: ${order.orderId}
Customer: ${customerName}
Total: ₹${total}
Payment: ${paymentType.toUpperCase()}
Pickup OTP: ${order.pickupOTP}

The order has been added to Live Orders.`);
        
        // Reset form
        document.getElementById('customerName').value = '';
        document.getElementById('customerEmail').value = '';
        document.getElementById('paymentType').value = 'cash';
        cart = {};
        displayMenu();
        updateCart();
        
      } catch (error) {
        console.error('Error placing order:', error);
        showToast('Failed to place order', 'error');
      }
    }

    // Toast notification
    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 10);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Initialize
    loadMenu();
  </script>
</body>
</html>
