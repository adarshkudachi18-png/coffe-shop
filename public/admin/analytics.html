<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics - BeanBox CafÃ© Admin</title>
  <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">â˜•</div>
        <h2>BeanBox Admin</h2>
        <p class="admin-email" id="adminEmail"></p>
      </div>
      
      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item">
          <span class="nav-icon">ðŸ“Š</span>
          <span class="nav-text">Dashboard</span>
        </a>
        <a href="analytics.html" class="nav-item active">
          <span class="nav-icon">ðŸ“ˆ</span>
          <span class="nav-text">Analytics</span>
        </a>
        <a href="menu.html" class="nav-item">
          <span class="nav-icon">ðŸ“‹</span>
          <span class="nav-text">Menu</span>
        </a>
        <a href="live-orders.html" class="nav-item">
          <span class="nav-icon">ðŸ””</span>
          <span class="nav-text">Live Orders</span>
        </a>
        <a href="completed.html" class="nav-item">
          <span class="nav-icon">âœ…</span>
          <span class="nav-text">Completed</span>
        </a>
        <a href="walk-in.html" class="nav-item">
          <span class="nav-icon">ðŸš¶</span>
          <span class="nav-text">Walk-in Order</span>
        </a>
        <a href="#" class="nav-item nav-logout" onclick="handleLogout()">
          <span class="nav-icon">ðŸšª</span>
          <span class="nav-text">Logout</span>
        </a>
      </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
      <header class="top-header">
        <button class="menu-toggle" id="menuToggle">â˜°</button>
        <h1>Sales Analytics</h1>
        <div class="header-actions">
          <span class="current-time" id="currentTime"></span>
        </div>
      </header>
      
      <div class="content-area">
        <!-- Period Filter -->
        <div class="analytics-header">
          <h2>Performance Overview</h2>
          <div class="filter-buttons">
            <button class="filter-btn active" data-period="today" onclick="changePeriod('today')">Today</button>
            <button class="filter-btn" data-period="week" onclick="changePeriod('week')">This Week</button>
            <button class="filter-btn" data-period="month" onclick="changePeriod('month')">This Month</button>
          </div>
        </div>
        
        <!-- KPI Cards -->
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-icon">ðŸ“¦</div>
            <div class="kpi-content">
              <div class="kpi-label">Total Orders</div>
              <div class="kpi-value" id="total-orders">0</div>
            </div>
          </div>
          
          <div class="kpi-card">
            <div class="kpi-icon">ðŸ’°</div>
            <div class="kpi-content">
              <div class="kpi-label">Total Revenue</div>
              <div class="kpi-value">â‚¹<span id="total-revenue">0</span></div>
            </div>
          </div>
          
          <div class="kpi-card">
            <div class="kpi-icon">ðŸ’³</div>
            <div class="kpi-content">
              <div class="kpi-label">Online Orders</div>
              <div class="kpi-value" id="online-orders">0</div>
            </div>
          </div>
          
          <div class="kpi-card">
            <div class="kpi-icon">ðŸ’µ</div>
            <div class="kpi-content">
              <div class="kpi-label">Cash Orders</div>
              <div class="kpi-value" id="cash-orders">0</div>
            </div>
          </div>
        </div>
        
        <!-- Analytics Grid -->
        <div class="analytics-grid">
          <!-- Payment Breakdown -->
          <div class="analytics-card">
            <h3>Payment Breakdown</h3>
            <div class="payment-breakdown">
              <div class="payment-item">
                <span>ðŸ’³ Online Payments</span>
                <span class="payment-value">â‚¹<span id="online-revenue">0</span></span>
              </div>
              <div class="payment-item">
                <span>ðŸ’µ Cash Payments</span>
                <span class="payment-value">â‚¹<span id="cash-revenue">0</span></span>
              </div>
            </div>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border);">
              <div class="payment-item">
                <span><strong>Total Revenue</strong></span>
                <span class="payment-value"><strong>â‚¹<span id="revenue-total">0</span></strong></span>
              </div>
            </div>
          </div>
          
          <!-- Top Selling Items -->
          <div class="analytics-card">
            <h3>Top Selling Items</h3>
            <div id="topItems" class="top-items">
              <div class="loading">Loading...</div>
            </div>
          </div>
        </div>
        
        <!-- Daily Revenue Chart (Simple visualization) -->
        <div class="chart-container">
          <h3>Daily Revenue Trend</h3>
          <div id="dailyChart" class="daily-chart">
            <div class="loading">Loading...</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../js/utils.js"></script>
  <script src="../js/admin-common.js"></script>
  <script>
    let currentPeriod = 'today';

    async function loadAnalytics() {
      try {
        const analytics = await apiCall(`/analytics?period=${currentPeriod}`);
        
        // Update KPIs
        document.getElementById('total-orders').textContent = analytics.totalOrders || 0;
        document.getElementById('total-revenue').textContent = analytics.totalRevenue || 0;
        document.getElementById('online-orders').textContent = analytics.onlineOrders || 0;
        document.getElementById('cash-orders').textContent = analytics.cashOrders || 0;
        
        // Update payment breakdown
        document.getElementById('online-revenue').textContent = analytics.onlineRevenue || 0;
        document.getElementById('cash-revenue').textContent = analytics.cashRevenue || 0;
        document.getElementById('revenue-total').textContent = analytics.totalRevenue || 0;
        
        // Display top items
        displayTopItems(analytics.topItems || {});
        
        // Display daily chart
        displayDailyChart(analytics.dailyData || []);
      } catch (error) {
        console.error('Error loading analytics:', error);
      }
    }

    function displayTopItems(topItems) {
      const container = document.getElementById('topItems');
      
      const items = Object.entries(topItems)
        .map(([name, data]) => ({ name, ...data }))
        .sort((a, b) => b.revenue - a.revenue)
        .slice(0, 10);
      
      if (items.length === 0) {
        container.innerHTML = '<div class="empty-state">No data available</div>';
        return;
      }
      
      container.innerHTML = items.map(item => `
        <div class="top-item">
          <div>
            <div style="font-weight: 600;">${item.name}</div>
            <div style="font-size: 13px; color: var(--text-light);">${item.count} sold</div>
          </div>
          <div style="font-weight: 700; color: var(--primary);">â‚¹${item.revenue}</div>
        </div>
      `).join('');
    }

    function displayDailyChart(dailyData) {
      const container = document.getElementById('dailyChart');
      
      if (dailyData.length === 0) {
        container.innerHTML = '<div class="empty-state">No data available</div>';
        return;
      }
      
      const maxRevenue = Math.max(...dailyData.map(d => d.totalRevenue));
      
      container.innerHTML = `
        <div class="chart-bars">
          ${dailyData.map(day => {
            const height = maxRevenue > 0 ? (day.totalRevenue / maxRevenue) * 200 : 0;
            const date = new Date(day.date);
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            
            return `
              <div class="chart-bar-item">
                <div class="chart-bar-value">â‚¹${day.totalRevenue}</div>
                <div class="chart-bar" style="height: ${height}px; background: var(--primary);"></div>
                <div class="chart-bar-label">${dayName}</div>
                <div class="chart-bar-sublabel">${day.totalOrders} orders</div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function changePeriod(period) {
      currentPeriod = period;
      
      // Update active button
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.period === period) {
          btn.classList.add('active');
        }
      });
      
      loadAnalytics();
    }

    // Initialize
    loadAnalytics();
    
    // Auto-refresh every 60 seconds
    setInterval(loadAnalytics, 60000);
  </script>
  
  <style>
    .daily-chart {
      padding: 20px 0;
    }
    
    .chart-bars {
      display: flex;
      gap: 15px;
      align-items: flex-end;
      justify-content: space-around;
      min-height: 250px;
      padding: 20px 0;
    }
    
    .chart-bar-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    
    .chart-bar {
      width: 100%;
      min-height: 20px;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s;
      background: var(--primary);
      box-shadow: 0 2px 8px rgba(107, 68, 35, 0.3);
    }
    
    .chart-bar-item:hover .chart-bar {
      background: var(--primary-dark);
      transform: translateY(-5px);
    }
    
    .chart-bar-value {
      font-weight: 700;
      color: var(--primary);
      font-size: 14px;
    }
    
    .chart-bar-label {
      font-weight: 600;
      font-size: 13px;
      text-align: center;
    }
    
    .chart-bar-sublabel {
      font-size: 11px;
      color: var(--text-light);
      text-align: center;
    }
    
    @media (max-width: 768px) {
      .chart-bars {
        flex-direction: column;
        gap: 20px;
        align-items: stretch;
      }
      
      .chart-bar {
        height: 20px !important;
        width: 100%;
        border-radius: 0 8px 8px 0;
      }
      
      .chart-bar-item {
        flex-direction: row;
        justify-content: space-between;
      }
    }
  </style>
</body>
</html>
