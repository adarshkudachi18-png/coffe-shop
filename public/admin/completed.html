<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Completed Orders - BeanBox Café Admin</title>
  <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">☕</div>
        <h2>BeanBox Admin</h2>
        <p class="admin-email" id="adminEmail"></p>
      </div>
      
      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item">
          <span class="nav-icon">📊</span>
          <span class="nav-text">Dashboard</span>
        </a>
        <a href="analytics.html" class="nav-item">
          <span class="nav-icon">📈</span>
          <span class="nav-text">Analytics</span>
        </a>
        <a href="menu.html" class="nav-item">
          <span class="nav-icon">📋</span>
          <span class="nav-text">Menu</span>
        </a>
        <a href="live-orders.html" class="nav-item">
          <span class="nav-icon">🔔</span>
          <span class="nav-text">Live Orders</span>
        </a>
        <a href="completed.html" class="nav-item active">
          <span class="nav-icon">✅</span>
          <span class="nav-text">Completed</span>
        </a>
        <a href="walk-in.html" class="nav-item">
          <span class="nav-icon">🚶</span>
          <span class="nav-text">Walk-in Order</span>
        </a>
        <a href="#" class="nav-item nav-logout" onclick="handleLogout()">
          <span class="nav-icon">🚪</span>
          <span class="nav-text">Logout</span>
        </a>
      </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
      <header class="top-header">
        <button class="menu-toggle" id="menuToggle">☰</button>
        <h1>Completed Orders</h1>
        <div class="header-actions">
          <div class="filter-buttons">
            <button class="filter-btn active" data-period="today" onclick="changePeriod('today')">Today</button>
            <button class="filter-btn" data-period="week" onclick="changePeriod('week')">This Week</button>
            <button class="filter-btn" data-period="month" onclick="changePeriod('month')">This Month</button>
            <button class="filter-btn" data-period="all" onclick="changePeriod('all')">All Time</button>
          </div>
          <span class="current-time" id="currentTime"></span>
        </div>
      </header>
      
      <div class="content-area">
        <!-- Summary Cards -->
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-icon">✅</div>
            <div class="kpi-content">
              <div class="kpi-label">Total Completed</div>
              <div class="kpi-value" id="total-completed">0</div>
            </div>
          </div>
          
          <div class="kpi-card">
            <div class="kpi-icon">💰</div>
            <div class="kpi-content">
              <div class="kpi-label">Total Revenue</div>
              <div class="kpi-value">₹<span id="total-revenue">0</span></div>
            </div>
          </div>
        </div>
        
        <!-- Search Bar -->
        <div class="search-bar">
          <input 
            type="text" 
            id="searchInput" 
            class="search-input" 
            placeholder="🔍 Search by order ID, customer name, or email..."
            oninput="filterOrders()"
          >
        </div>
        
        <!-- Orders List -->
        <div class="orders-list" id="ordersList">
          <div class="loading">Loading completed orders...</div>
        </div>
      </div>
    </main>
  </div>

  <script src="../js/utils.js"></script>
  <script src="../js/admin-common.js"></script>
  <script>
    let allOrders = [];
    let filteredOrders = [];
    let currentPeriod = 'today';

    // Load completed orders
    async function loadOrders() {
      try {
        const orders = await apiCall('/orders');
        allOrders = orders.filter(o => o.status === 'completed');
        
        // Apply period filter
        filterByPeriod();
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('ordersList').innerHTML = 
          '<div class="empty-state">Failed to load orders</div>';
      }
    }

    // Filter by period
    function filterByPeriod() {
      const now = new Date();
      
      if (currentPeriod === 'all') {
        filteredOrders = allOrders;
      } else if (currentPeriod === 'today') {
        const today = now.toISOString().split('T')[0];
        filteredOrders = allOrders.filter(o => {
          const orderDate = new Date(o.createdAt).toISOString().split('T')[0];
          return orderDate === today;
        });
      } else if (currentPeriod === 'week') {
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        filteredOrders = allOrders.filter(o => new Date(o.createdAt) >= weekAgo);
      } else if (currentPeriod === 'month') {
        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        filteredOrders = allOrders.filter(o => new Date(o.createdAt) >= monthAgo);
      }
      
      updateSummary();
      displayOrders(filteredOrders);
    }

    // Update summary
    function updateSummary() {
      document.getElementById('total-completed').textContent = filteredOrders.length;
      const totalRevenue = filteredOrders.reduce((sum, order) => sum + order.total, 0);
      document.getElementById('total-revenue').textContent = totalRevenue;
    }

    // Display orders
    function displayOrders(orders) {
      const container = document.getElementById('ordersList');
      
      if (orders.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 80px; margin-bottom: 20px;">✅</div>
            <h3>No Completed Orders</h3>
            <p>Completed orders will appear here</p>
          </div>
        `;
        return;
      }
      
      // Sort by completion time (newest first)
      const sortedOrders = [...orders].sort((a, b) => 
        new Date(b.completedAt || b.createdAt) - new Date(a.completedAt || a.createdAt)
      );
      
      container.innerHTML = sortedOrders.map(order => `
        <div class="order-card">
          <div class="order-header">
            <div>
              <div class="order-id">Order #${order.orderId}</div>
              <div class="order-time">
                Placed: ${formatDate(order.createdAt)} • ${formatTime(order.createdAt)}
                ${order.completedAt ? `<br>Completed: ${formatDate(order.completedAt)} • ${formatTime(order.completedAt)}` : ''}
              </div>
            </div>
            <div>
              <span class="payment-badge payment-${order.paymentType}">
                ${order.paymentType === 'online' ? '💳 Online' : '💵 Cash'}
              </span>
            </div>
          </div>
          
          <div class="order-body">
            <div class="order-info">
              <div class="order-label">Customer</div>
              <div class="order-value">${order.customerName}</div>
            </div>
            
            <div class="order-info">
              <div class="order-label">Email</div>
              <div class="order-value">${order.customerEmail}</div>
            </div>
            
            <div class="order-info">
              <div class="order-label">Status</div>
              <div class="order-value">
                <span class="status-badge status-completed">COMPLETED</span>
              </div>
            </div>
            
            <div class="order-info">
              <div class="order-label">Total</div>
              <div class="order-value">₹${order.total}</div>
            </div>
            
            <div class="order-info">
              <div class="order-label">Pickup OTP</div>
              <div class="order-otp">${order.pickupOTP}</div>
            </div>
          </div>
          
          <div class="order-items">
            <div class="order-items-title">Items:</div>
            ${order.items.map(item => `
              <div class="order-item">
                <span>${item.name} x${item.quantity}</span>
                <span>₹${item.price * item.quantity}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    // Filter orders by search
    function filterOrders() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      if (!searchTerm) {
        displayOrders(filteredOrders);
        return;
      }
      
      const searched = filteredOrders.filter(order => 
        order.orderId.toLowerCase().includes(searchTerm) ||
        order.customerName.toLowerCase().includes(searchTerm) ||
        order.customerEmail.toLowerCase().includes(searchTerm)
      );
      
      displayOrders(searched);
    }

    // Change period
    function changePeriod(period) {
      currentPeriod = period;
      
      // Update active button
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.period === period) {
          btn.classList.add('active');
        }
      });
      
      filterByPeriod();
    }

    // Initialize
    loadOrders();
    
    // Auto-refresh every 30 seconds
    setInterval(loadOrders, 30000);
  </script>
</body>
</html>
